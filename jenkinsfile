pipeline {
    agent any
    environment {
        AWS_REGION = 'ap-south-1'
        AMI_NAME_PATTERN = 'Windows_Server-2019-English-Full-Base*'
        AWS_ACCESS_KEY_ID = credentials('check_latest_ami')
        AWS_SECRET_ACCESS_KEY = credentials('check_latest_ami')
    }
    try {
    stage ('Check Latest AMI') { 
                script {
                    def amiId = sh(
                        script: "aws ec2 describe-images --region ${env.AWS_REGION} --owners amazon --filters 'Name=name,Values=${env.AMI_NAME_PATTERN}' --query 'Images[*].[ImageId, CreationDate]' --output text | sort -k2 -r | head -n1 | awk '{print \$1}'",
                        returnStdout: true
                    ).trim()
                    if (amiId.empty) {
                        error('Latest AMI not found. Exiting pipeline.')
                    } else {
                        echo "Latest AMI ID is: ${amiId}"
                        env.AMI_ID = amiId
                    }
                }
            
        

        stage('Terraform Init') {
                    sh 'terraform init'
                    sh "terraform plan -var='ami_id=${env.AMI_ID}'"
                    sh "terraform apply -var='ami_id=${env.AMI_ID}'"
        }        
    }
    } catch (error) {
         if (errorMessage.contains("Error asking for approval: EOF")) {
             echo 'Ignoring error and marking build as successful'
             currentBuild.result = 'SUCCESS'
             return
        } else {
            error(err.getMessage())
            currentBuild.result = 'FAILURE'
            return
        }
        }

}

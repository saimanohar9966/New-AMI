pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
    

        stage('Fetch latest AMI') {
            steps {
                script {
                    def region = 'ap-south-1' // Change to your region
                    def ami = awsUtil.getLatestAmi(region, 'Windows-base-*')
                    env.AMI_ID = ami.id
                }
            }
        }

        stage('Apply Terraform') {
            steps {
                withCredentials([[$class: 'check_latest_ami', accessKeyVariable: 'AWS_ACCESS_KEY_ID', credentialsId: 'aws-credentials', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
                    dir('terraform') {
                        sh 'terraform init'
                        sh "terraform plan -var 'ami_id=${env.AMI_ID}'"
                        sh "terraform apply -var 'ami_id=${env.AMI_ID}'"
                    }
                }
            }
        }
    }
}
